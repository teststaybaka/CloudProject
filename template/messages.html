{% extends "template/base.html" %}
{% block head %}
{{ super() }}
<style>
.center-tags{
	text-align:center;
}
.background-color{
	padding: 50px;
}
.panel{
	margin-top: 50px;
}
.modify:before{
	content: "|";
	margin-right: 2px;
	color: #337ab7;
}
td{
 	max-width:200px; 
 	overflow-wrap: break-word;
}
.panel-title{
	font-size: 22px;
}
h1 i{
	margin-right: 5px;
	font-size: 19px;
}
.accepted, .finished{
	 color: green;
}
.declined{
	color: red;
}
.confirmed{
	color: black;
}
.pending{
	color: blue;
}
.message-text{
	font-style: italic;
    white-space: pre-wrap;
}
h4.proposal{
	margin-left: 8px;
	text-decoration: underline;
}
</style>

<script type="text/javascript">
$(function(){
	// var messageList = $("#message-list");
	
	var address = 'ws://104.196.35.247/' + {{ proposal.key.id() }};
	var ws = new WebSocket(address);
	var clicked = false;
	ws.onopen = function() {
        console.log('Connected');
        $("#send-message-button").click(function(){
        	var message = $("#message-body").val();
		    ws.send(message);
		  	clicked = true;
		  	$("#message-body").val('');
			appendMessage(message);
		});
    };
	ws.onclose = function() { 
      // websocket is closed.
      console.log("Connection is closed..."); 
    };
	
	
	function appendMessage(msg) {
		var cell1 = "<tr><td class='from'>from<b>";
		if (clicked) 
			cell1 += "You"
		else 
			cell1 += $("#opposite-firstname").val();
		cell1 += "</b> to <b>"
		if (!clicked) 
			cell1 += "You"
		else 
			cell1 += $("#opposite-firstname").val();
		cell1 += "</b></td>";

		var cell2 = "<td class='message-text' id='message-content'>-$" + msg + "</td></tr>";
		var cell = cell1 + cell2
		console.log(cell);
		$('#message-list tbody').append(cell);
	}

})	
</script>

{% endblock %}
{% block body %}
<input type="hidden" id="opposite-firstname" value="{{ opposite.firstname }}">
<div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading">
    <h1 class="panel-title">{{ service.title }} </h1>
  </div>
  <div class="panel-body">
    <p>Description: {{ service.description }}</p>
  </div>

  <h4 class="proposal"> Proposal Details </h4>

  <!-- Table -->
	<table class="table">
	<tr><td><b>Price:</b></td><td>${{ proposal.price }}</td></tr>
	<tr><td><b>Quantity:</b></td><td>{{ proposal.times }}</td></tr>
	<tr><td><b>Type:</b></td><td>{{ proposal.kind }}</td></tr>
	<tr><td><b>Progress:</b></td><td>{{ proposal.progress }}/{{ proposal.times }}</td></tr>
	<tr><td><b>Status:</b></td><td>{{ proposal.status }}</td></tr>
	</table>
</div>

<div class="panel panel-default">
  <!-- Default panel contents -->
  <div class="panel-heading">
    <h1 class="panel-title">Messages</h1>
  </div>
  <div class="panel-body">
    You have <span>{{ messages|count }}</span> message{% if messages|count > 1 %}s{% endif %}.
  </div>
  <table class="table messages" id="message-list">
  	<tbody>
    {% for message in messages %}
		<tr>
			<td class="from">from 
			<b>{% if message.sender == user.key %} You {% else %} {{ opposite.firstname }} {% endif %}</b> to
			<b>{% if message.receiver == user.key %} You {% else %} {{ opposite.firstname }} {% endif %}</b>
			</td>

			<td class="message-text" id="message-content">-${{ message.text }}</td>

		</tr>
	{% endfor %}
	</tbody>
	</table>

</div>

<div class="panel panel-default messages">
	<div class="panel-heading" id="message-title">
    <h1 class="panel-title">Send Messages</h1>
  	</div>
	<table class="table messages">
		<tr>
			<td class="center-tags"><textarea id="message-body" rows="5" cols="100"></textarea></td>
		</tr>
		<tr>
			<td class="center-tags"><input id="send-message-button" class="btn btn-success" type="submit" value="Send"/></td>
			<!-- <td class="center-tags"><input class="form-control" type="text" id="newMessage" autocomplete="off" placeholder="Type in your message and press enter !"><td> -->
		</tr>	
	</table>

</div>
{% endblock %}